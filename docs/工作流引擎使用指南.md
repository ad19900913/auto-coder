# 工作流引擎使用指南

## 概述

工作流引擎是自动化AI任务执行系统的核心组件，负责管理和执行结构化的任务流程。它支持工作流模板、步骤执行、人工审批、DoD检查等功能。

## 核心特性

### 1. 工作流模板系统
- **模板继承**: 支持基础模板和任务特定扩展
- **YAML配置**: 使用YAML格式定义工作流模板
- **步骤模板**: 可重用的步骤定义

### 2. 运行模式
- **人工审批模式 (Manual)**: 支持交互式确认和人工审批
- **自动化模式 (Automated)**: 完全自动化执行

### 3. 步骤类型
- **AI服务步骤**: 调用AI服务进行分析和生成
- **Git操作步骤**: 代码拉取、提交、PR创建等
- **Shell脚本步骤**: 执行系统命令（支持白名单）
- **数据获取步骤**: 从文件或API获取数据
- **文件导出步骤**: 导出结果到指定格式
- **验证步骤**: DoD检查和内容验证

### 4. 工件管理
- **标准化命名**: `{task_id}/{timestamp}/{step_name}`
- **自动归档**: 支持工件自动清理和归档
- **多格式输出**: 支持JSON、Markdown、Excel等格式

## 目录结构

```
workflows/
├── base/                    # 基础模板
│   ├── base_workflow.yaml   # 基础工作流定义
│   └── base_workflow.md     # 基础工作流文档
├── coding/                  # 编码任务工作流
│   ├── coding_workflow.yaml # 编码工作流定义
│   └── coding_workflow.md   # 编码工作流文档
├── review/                  # 代码审查工作流
├── doc/                     # 文档生成工作流
├── requirement_review/      # 需求评审工作流
└── custom/                  # 自定义任务工作流

prompts/
├── base/                    # 基础提示词模板
├── coding/                  # 编码任务提示词
├── review/                  # 代码审查提示词
├── doc/                     # 文档生成提示词
├── requirement_review/      # 需求评审提示词
└── custom/                  # 自定义任务提示词
```

## 使用方法

### 1. 通过CLI执行工作流任务

```bash
# 使用工作流引擎执行任务
python -m src.cli.main execute-workflow coding_task_example

# 查看任务状态
python -m src.cli.main task-status coding_task_example

# 列出所有任务
python -m src.cli.main list-tasks
```

### 2. 编程方式使用

```python
from src.core import ConfigManager, TaskManager, StateManager
from src.services import NotifyService

# 初始化组件
config_manager = ConfigManager("./config")
state_manager = StateManager()
notify_service = NotifyService(config_manager)
task_manager = TaskManager(config_manager, state_manager, notify_service)

# 执行工作流任务
success = task_manager.execute_task_with_workflow("coding_task_example")
```

### 3. 直接使用工作流引擎

```python
from src.core import ConfigManager, WorkflowEngine

# 初始化工作流引擎
config_manager = ConfigManager("./config")
workflow_engine = WorkflowEngine(config_manager)

# 执行工作流
import asyncio
result = asyncio.run(workflow_engine.execute_workflow(
    task_id="coding_task_example",
    task_type="coding",
    task_config={...}
))
```

## 工作流模板配置

### 基础模板结构

```yaml
# workflows/base/base_workflow.yaml
extends: null  # 基础模板不继承其他模板

global_config:
  default_mode: "manual"
  shortcuts_enabled: true
  default_timeout: 1800
  artifact_naming: "{task_id}/{timestamp}/{step_name}"

step_templates:
  ai_call:
    type: "ai_service"
    description: "AI服务调用"
    config:
      model: "claude"
      temperature: 0.7
      max_tokens: 4000
  
  git_operation:
    type: "git_service"
    description: "Git操作"
    config:
      operations: ["fetch", "commit", "create_pr"]
  
  human_approval:
    type: "pause"
    description: "人工审批"
    config:
      message: "请确认是否继续"
      timeout: 3600

default_steps:
  - name: "init"
    template: "ai_call"
    description: "初始化"
  
  - name: "finalize"
    template: "ai_call"
    description: "完成"
```

### 任务特定工作流

```yaml
# workflows/coding/coding_workflow.yaml
extends: "base_workflow"

coding_specific:
  feature_selection_enabled: true
  dod_check_enabled: true
  review_trigger_enabled: true

steps_sequence:
  - name: "init"
    template: "ai_call"
    description: "需求分析和功能点分解"
    config:
      prompt_template: "coding_init_prompt"
      output_format: "table"
  
  - name: "select_features"
    template: "feature_selection"
    description: "功能点选择"
    pause_for_approval: true
    config:
      selection_method: "interactive"
      supported_commands:
        - "继续"
        - "默认顺序"
        - "选择序号X,Y"
  
  - name: "implement"
    template: "ai_call"
    description: "代码实现"
    config:
      prompt_template: "coding_implement_prompt"
  
  - name: "test"
    template: "shell"
    description: "单元测试"
    config:
      command: "python -m pytest tests/"
      whitelist: ["python", "pytest"]
  
  - name: "commit"
    template: "git_operation"
    description: "提交代码"
    config:
      operation: "commit"
      message: "feat: 实现用户管理模块"

dod_rules:
  configurable: true
  init:
    - type: "file_exists"
      file_path: "requirements.txt"
    - type: "content_check"
      file_path: "README.md"
      required_content: ["# 用户管理模块"]
  
  implement:
    - type: "ai_validation"
      prompt: "检查代码是否包含完整的用户管理功能"
      model: "claude"
```

## 提示词模板

### 提示词模板结构

```markdown
# prompts/coding/coding_init_prompt.md

# 编码任务初始化提示词：需求分析和功能点分解

## 目标
作为企业级研发AI助手，你的目标是根据提供的任务描述，进行深入的需求分析，并输出一个结构化的"待实现功能点列表"表格。

## 角色
你是经验丰富的软件架构师和开发负责人，擅长将高层需求分解为可执行的功能点。

## 约束
1. 严格按照Markdown表格格式输出"待实现功能点列表"。
2. 表格必须包含以下列：`序号`、`接口/模块/文件/类`、`新增/修改`、`变更点`、`影响范围`、`兼容性说明`、`风险/注意事项`、`测试点`。
3. 对于每个功能点，请提供清晰、具体、可操作的描述。
4. 如果无法确定某些信息，请标注为"待定"或"N/A"，但尽量给出合理推断。
5. 输出后，请不要添加任何额外说明或对话，直接等待用户指令。

## 输入
- `task_description`: 编码任务的详细描述。
- `existing_design_docs`: 现有设计文档的上下文信息（如果提供）。
- `existing_codebase_summary`: 现有代码库的概要信息（如果提供）。

## 输出格式
```markdown
| 序号 | 接口/模块/文件/类 | 新增/修改 | 变更点 | 影响范围 | 兼容性说明 | 风险/注意事项 | 测试点 |
| ---- | ----------------- | --------- | ------ | -------- | ---------- | ------------- | ------- |
| 1    | [示例]            | [示例]    | [示例] | [示例]   | [示例]     | [示例]        | [示例]  |
| ...  | ...               | ...       | ...    | ...      | ...        | ...           | ...     |
```
```

## 配置说明

### 任务配置文件

```yaml
# config/tasks/coding_task_example.yaml
task_id: "coding_task_example"
name: "编码任务示例"
type: "coding"
enabled: true

# 工作流配置
workflow_mode: "manual"  # manual 或 automated

# 任务参数
parameters:
  description: "开发用户管理模块"
  repo_url: "https://github.com/example/user-management"
  branch: "main"

# AI配置
ai:
  provider: "claude"
  model: "claude-3-sonnet-20240229"
  temperature: 0.7

# 工作流特定配置
workflow_config:
  shortcuts_enabled: true
  dod_check_enabled: true
  artifact_retention_days: 30
```

### 系统配置文件

```yaml
# config/system.yaml
name: "自动化AI任务执行系统"
version: "1.0.0"
max_concurrent_tasks: 5

# 工作流引擎配置
workflow_engine:
  max_workers: 5
  default_timeout: 1800
  artifact_retention_days: 30
  
# 通知配置
notifications:
  dingtalk:
    webhook_url: "${DINGTALK_WEBHOOK}"
    secret: "${DINGTALK_SECRET}"
```

## 最佳实践

### 1. 工作流设计
- 将复杂任务分解为可管理的步骤
- 使用模板继承减少重复配置
- 为关键步骤添加DoD检查
- 合理设置人工审批点

### 2. 提示词编写
- 明确角色和目标
- 提供具体的约束和格式要求
- 包含示例和上下文信息
- 支持交互式操作

### 3. 错误处理
- 配置合理的重试策略
- 设置适当的超时时间
- 实现优雅的错误恢复
- 提供详细的错误日志

### 4. 安全考虑
- 使用命令白名单限制Shell执行
- 敏感信息使用环境变量
- 定期清理工件和日志
- 实现访问控制和审计

## 故障排除

### 常见问题

1. **工作流模板加载失败**
   - 检查YAML语法是否正确
   - 确认模板文件路径存在
   - 验证基础模板是否正确

2. **步骤执行失败**
   - 检查步骤配置是否正确
   - 确认依赖服务是否可用
   - 查看详细错误日志

3. **人工审批超时**
   - 检查通知配置是否正确
   - 确认审批流程是否正常
   - 调整超时时间设置

4. **工件保存失败**
   - 检查目录权限
   - 确认磁盘空间充足
   - 验证文件路径格式

### 调试技巧

1. **启用详细日志**
   ```bash
   python -m src.cli.main --verbose execute-workflow task_id
   ```

2. **查看工作流状态**
   ```bash
   python -m src.cli.main task-status task_id
   ```

3. **检查工件目录**
   ```bash
   ls -la workspace/task_id/artifacts/
   ```

4. **查看系统日志**
   ```bash
   tail -f logs/cli.log
   ```

## 扩展开发

### 添加新的步骤类型

1. 在`WorkflowEngine`中添加新的执行方法
2. 在基础模板中定义步骤模板
3. 在任务特定工作流中使用新步骤

### 自定义验证规则

1. 在`WorkflowEngine`中实现验证逻辑
2. 在DoD规则中配置验证参数
3. 在任务配置中启用验证

### 集成外部服务

1. 创建新的服务类
2. 在`WorkflowEngine`中集成服务
3. 在步骤配置中指定服务参数

## 总结

工作流引擎提供了强大的任务执行能力，支持复杂的业务流程和自动化需求。通过合理的设计和配置，可以实现高效、可靠的AI任务执行系统。
