## 原始需求背景
我想实现以下功能
0. 使用一种脚本语言，在windows环境下，实现自动调用AI的接口，完成以下几点功能
1. 让AI在指定的时间点，执行我指定的任务清单，任务类型分为编码任务、文档任务、走查类任务
2. 如果是编码任务，可以指定在那个项目的那个分支上进行开发，开发完成后，自动生成commit信息，并提交到git仓库。
3. 如果是走查类任务，需要参考我们公司的编码规范、红线规范，对指定项目的指定分支下的代码，指定时间之后的提交记录进行审查，把审查意见输出到文档中
4. 如果是文档类任务，就按照我的要求，输出文档

## 补充需求背景-1
1. 任务调度和时间管理
时间点指定方式：您希望如何指定执行时间？是固定的时间点（如每天9点），还是可以设置多个时间点？
    - 使用crontab表达式，需要支持多个表达式
任务频率：任务是一次性执行，还是需要定期重复执行？
    - 根据表达式来决定
时区处理：是否需要考虑时区问题？
    - 不考虑，使用0时区
2. 编码任务的具体要求
项目识别：如何识别和定位指定的项目？是通过项目路径、项目名称，还是其他标识？
    - 通过配置文件指定，就是说会有一个整体的配置文件指定需要执行的任务，是一次性，还是周期性。
分支管理：如果指定的分支不存在，是否需要自动创建？开发完成后是否需要合并到主分支？
    - 可以自动创建分支，不要自动合并到主分支，需要人工审查后，由人工合并
代码生成：AI生成的代码是否需要人工审核后再提交，还是可以直接自动提交？
    - 我建议是使用两个角色，一个是编码者，一个是走查者。编码者改完代码后，走查者根据git对比出的差异，进行走查，输出走查意见
3. 走查类任务的审查范围
时间范围：您提到"指定时间之后的提交记录"，这个时间是指某个具体的日期时间点吗？
    - 是的，例如可以指定审查V3.17.8分支上，2025-08-01之后提交的代码，因为V3.17.8是2025-08-01之后才开工的
审查深度：是只审查代码风格和规范，还是需要深入分析代码质量和潜在问题？
    - 深入分析代码质量和潜在问题，以及设计上不合理的地方
输出格式：审查意见的输出文档格式有特殊要求吗？（如Markdown、Word、Excel等）
    - 使用Markdown吧
4. 文档类任务
文档类型：主要生成什么类型的文档？（如技术文档、API文档、用户手册等）
    - 主要是Markdown
输出格式：文档的输出格式和存储位置有要求吗？
    - 可以由配置文件指定格式和位置
5. 技术实现相关
AI接口：您计划使用哪个AI服务？（如OpenAI、Claude、本地部署的模型等）
    - 我不清楚有哪些模型提供了API服务的，OpenAI、Claude、Deepseek？你还知道哪些？
Git操作：是否需要支持多种Git托管平台？（如GitHub、GitLab、Gitee等）
    - 支持这两个GitHub、GitLab
错误处理：当任务执行失败时，需要什么样的错误处理和通知机制？
    - 使用钉钉机器人通知
6. 系统集成
配置管理：任务配置、AI接口配置等如何管理？是否需要配置文件或数据库？
    - 使用配置文件管理就好
日志记录：是否需要详细的执行日志和审计记录？
    - 记录简单的日志吧
监控告警：是否需要任务执行状态的监控和异常告警？
    - 使用钉钉机器人通知

## 补充需求背景-2
1. 任务执行流程的细节
您提到"编码者改完代码后，走查者根据git对比出的差异，进行走查"，这里有几个问题：
走查时机：走查是在编码任务完成后立即执行，还是需要单独配置走查任务？
    - 可以通过一个状态文件来交互，一开始任务是编码状态，编码任务完成后更新为走查状态，走查者扫描到状态更新，就启动走查。走查完成后，把走查意见写到文件中，并且把状态再次更新成编码状态，编码者扫描到以后再次启动编码，结合走查意见就行修改。当某一次走查者走查完发现没有问题时，结束整个编码任务
走查范围：走查是针对编码任务产生的所有代码变更，还是可以指定特定的文件或目录？
    - 所有改动
走查结果处理：走查完成后，如果发现问题，是否需要自动回滚代码或者通知编码者？
    - 更新任务的状态，就像信号量一样协调编码者和走查者交替执行任务
2. 配置文件结构
任务配置：每个任务是否需要独立的配置项？比如：
任务名称、类型、crontab表达式
项目路径、分支名称
AI模型选择、参数配置
输出路径、通知配置等
配置层级：是否需要支持全局配置和任务级配置？
    - 每个任务需要单独的配置项
    - 支持全局配置和任务级配置
3. AI模型选择和配置
关于AI模型，我了解一些主流选择：
OpenAI GPT系列：功能强大，但需要科学上网
Claude系列：代码能力优秀，支持中文
DeepSeek：国产模型，代码能力不错
通义千问：阿里云模型，国内访问稳定
文心一言：百度模型，国内访问稳定
您希望支持哪些模型？是否需要支持模型切换和参数调优？
    - Claude\DeepSeek，先用这两个吧
4. 钉钉机器人通知
通知内容：需要通知哪些信息？（任务开始、完成、失败、走查结果等）
    - 你自己决定就好
通知频率：是否需要避免重复通知？比如任务执行时间很长的情况
    - 暂不考虑
通知权限：是否需要支持@特定人员？
    - 可以设置@人员
5. 错误处理和重试机制
重试策略：任务失败后是否需要自动重试？重试次数和间隔如何设置？
    - 可以配置重试次数，连续失败后就停止。重试间隔需要越来越长
部分失败处理：如果编码任务部分成功（比如生成了代码但提交失败），如何处理？
    - 重试，如果多次提交失败，就放弃提交，把代码改动保留到本地
6. 日志和审计
日志级别：需要记录哪些级别的日志？（DEBUG、INFO、WARN、ERROR）
    - info
日志保留：日志文件需要保留多长时间？
    - 30天吧
敏感信息：AI API密钥等敏感信息在日志中如何处理？
    - 脱敏处理

## 补充需求背景-3
1. 状态文件机制
状态文件位置：状态文件是放在项目根目录，还是放在系统工作目录？
    - 放在系统工作目录吧
状态文件格式：使用JSON还是其他格式？包含哪些状态值？（如：coding, reviewing, completed等）
    - json吧，包含哪些值你自己定
2. 任务优先级和并发
任务并发：是否支持多个任务同时执行？还是串行执行？
    - 支持并发
任务优先级：是否需要支持任务优先级设置？
    - 支持优先级
3. 系统部署
运行方式：是作为Windows服务运行，还是手动启动的脚本？
    - 手动脚本就行
依赖管理：是否需要考虑Python环境、Git客户端等依赖的自动安装？
    - 暂不考虑
4. 监控和调试
任务状态查看：是否需要提供命令行工具查看当前任务执行状态？
    - 需要提供
手动干预：是否需要支持手动触发任务或中断正在执行的任务？
    - 需要提供

## 补充需求背景-4
走查类任务是否只用于审查编码任务的输出？
    - 不是
还是说走查类任务也可以独立存在，用于审查其他分支的代码？
    - 可以独立存在，审查指定分支的代码

## 补充需求背景-5
1. 再增加一种内置的任务类型：需求评审，目标是审查需求文档，并结合当前的代码实现，指出需求文档中不合理的地方，把审查意见输出到markdown文件中
2. 再增加一种内置的任务类型：自定义，目标是兼容任意场景的任务，再配置文件中，指定好任务目标、任务产出。
3. 结合之前提到的三种任务类型，一共需要支持五种任务类型

## 补充需求背景-6
1. 需求评审任务的执行时机
这个任务是在什么时候触发？是定期执行，还是基于某些事件触发？
    - 由配置文件指定
如何获取"当前代码实现"？是指定分支的最新代码，还是某个特定版本的代码？
    - 可以在配置文件中指定项目目录、分支、要参考的代码包路径
2. 需求评审任务的输入来源
需求文档的来源是什么？是文件路径、URL，还是其他方式？
    - 我会把word或者markdown形式的文档以本地文件形式放在工作目录，配置文件中指定本地目录即可
代码实现的范围如何确定？是整个项目，还是特定的模块？
    - 配置文件中可以指定多个类路径或者包路径
3. 自定义任务的灵活性
自定义任务是否也需要支持AI调用？还是纯粹的自定义逻辑？
    - 需要支持AI调用
任务产出是否也需要支持多种格式（如Markdown、JSON、CSV等）？
    - 一般就是Markdown，也可能是excel，或者PPT
4. 任务类型的优先级和调度
这5种任务类型是否都支持相同的调度方式（crontab表达式）？
    - 是的，调度方式一致
是否需要为不同类型的任务设置不同的默认参数？
    - 暂不考虑吧
5. 需求评审任务的AI模型选择
需求评审任务是否也需要支持AI模型选择？还是固定使用某个模型？
    - 支持选择吧
是否需要特殊的提示词模板来指导AI进行需求评审？
    - 可以在配置文件中指定

## 补充需求背景-7
1. 需求评审任务的代码分析深度
是否需要分析代码的架构设计、接口定义、数据模型等？
    - 需要
还是主要关注功能实现与需求的一致性？
    - 也需要分析
2. 自定义任务的AI调用方式
自定义任务是否也需要像其他任务一样支持模型选择和参数配置？
    - 需要支持
是否需要提供一些预设的自定义任务模板？
    - 暂不考虑，后期再慢慢完善
3. 任务间的依赖关系
除了编码任务和走查任务的协作关系，其他任务类型之间是否也需要支持依赖关系？
    - 暂时没有
比如需求评审任务完成后，是否可能触发编码任务？
    - 不同的任务之间互不干扰
4. 输出文件的命名和组织
不同任务类型的输出文件是否需要统一的命名规范？
    - 需要统一命名规范
是否需要支持输出文件的版本管理和归档？
    - 暂不考虑

## 补充需求背景-8
编码规范文件：您希望如何配置和管理编码规范？
    - 配置文件中指定编码规范文件的路径，编码规范文件是md文件
任务超时时间：每种任务类型的合理超时时间是多少？
    - 你自己决定
AI参数调优：除了基础参数，是否需要支持更多高级参数？
    - 你自己决定
状态文件管理：是否需要定期清理和归档机制？
    - 你自己决定
通知模板：您希望通知内容包含哪些具体信息？
    - 你自己决定

## 补充需求背景-9
1. 编码规范文件的组织方式
是否需要按语言类型分类（Java、Python、前端等）？
还是使用一个统一的编码规范文件？
    - 根据不同的语言分类
2. 状态文件清理的时机
每天凌晨2点清理是否合适？
还是希望在其他时间点？
    - 凌晨2点清理
3. 通知模板的个性化
是否需要支持不同任务类型使用不同的通知模板？
还是使用统一的模板？
    - 你自己决定

## 补充需求背景-10
我有一个想法，我之前所说的不同的任务类型，每一种任务类型都应该对应一种工作流程规范。规范中指明在执行这项工作时应该遵循的流程步骤和中间产物。这样执行每一种任务时，可以通过配置文件执行任务内容，加上任务规范来约束AI的运行行为，这样是不是更完善？

## 补充需求背景-11
你希望“严格模板”为主（任务只能少量覆盖）还是“灵活可编排”为主（可增删改步骤）？
    - “严格模板”为主
是否允许“shell/脚本执行步骤”？考虑到Windows安全与稳定性，建议默认关闭，可按任务白名单开启。
    - 只允许在任务指定的工作目录下执行shell/脚本
是否需要“人工审批步”（pause，等待手动继续）？如在“commit”与“开PR”之间。
    - 可以在任务配置文件中指定是否需要人工审批
默认模板是否按我上面的初版落地？是否需要增加：单测/构建/安全扫描等步骤（coding、review）？
    - 可以增加
自定义任务是否需要支持多格式同时导出（已支持multi_format），是否需要“数据源拉取/预处理”标准步骤？
    - 可以支持
步级通知默认策略：仅错误和关键节点（ai_call、commit、report）通知，是否同意？
    - 可以，没问题
产物命名模板是否采用当前{task_id}/{timestamp}规范，是否需要追加{step_name}？
    - 追加{step_name}
是否需要在全局增加workflows/目录存放“人类可读”的流程规范文档（md），与可执行模板（yaml）对应？
    - 需要增加，因为配置文件可读性有点差

## 补充需求背景-12
交互式确认：是否在每个关键步骤后都要暂停确认？还是只在特定节点（如人工审批步）？
    - 建议支持两种方式，白天我在公司时，以人工审批方式运行，晚上我不在公司时，以自动化方式运行。支持在配置文件中指定整体运行方式以及单个任务的运行方式
快捷指令：是否需要支持类似"继续"、"默认顺序"、"选择序号X,Y"的交互方式？
    - 人工审批方式运行时，可以支持
DoD检查：每种任务类型是否都需要类似的验证机制？
    - 可配置
模板继承：是否需要支持基础模板+任务特定扩展的方式？
    - 需要支持

## 补充需求背景-13
功能点列表阶段：是否需要在init步骤中明确输出"待实现功能点表格"？
    - 需要输出
选择功能点：是否需要支持"序号X,Y"批量选择功能点的机制？
    - 需要支持
验证实现表格：是否需要在DoD检查中输出"修改点表格"？
    - 需要输出
快捷指令支持：是否需要在manual模式下明确支持"继续"、"默认顺序"、"选择序号X,Y"？
    - 需要
DoD检查的配置化：目前是固定规则，是否需要更灵活的配置？
    - 需要支持
与review任务的协作：编码任务完成后如何触发review任务？
    - 看你的设计,你可以自己思考最佳实现。我提供一种思路，每个任务对应一个线程。编码任务A对应线程A，编码任务B对应线程B，线程A执行完任务，将结果介入文件或者数据库。并开启新的走查任务C，对应线程C，线程C通过读取编码任务A的任务描述和提交记录，以及过程中间文档，来完成走查任务
AI提示词模板：coding_init_prompt等模板的具体内容需要定义
    - 这个指定一个文件路径，后续我会在文件中补充
Git操作详细配置：create_pr的具体实现方式
    - 你来决定
脚本执行的安全性：白名单机制的具体实现
    - 可以指定白名单清单
TaskExecutor的扩展：如何与现有的任务执行器集成？
    - 你来决定
状态管理：工作流状态如何与现有的StateManager集成？
    - 你来决定
通知机制：步骤级通知如何与现有NotifyService集成？
    - 你来决定
    

请阅读以上文档，对于需求如果过还有疑问，一定和我交流，我会完善需求文档。需求没有明确前，不要开始编码

## 工作流引擎实现完成状态

### 已完成的工作

#### 1. 工作流引擎核心实现 ✅
- **WorkflowEngine类**: 完整的工作流执行引擎
- **WorkflowTemplate类**: 工作流模板加载和管理
- **WorkflowContext类**: 工作流执行上下文
- **StepResult类**: 步骤执行结果管理
- **WorkflowMode枚举**: 支持人工审批和自动化两种模式
- **StepStatus枚举**: 完整的步骤状态管理

#### 2. 工作流模板系统 ✅
- **基础模板**: `workflows/base/base_workflow.yaml` 和对应的Markdown文档
- **编码任务工作流**: `workflows/coding/coding_workflow.yaml` 和文档
- **代码审查工作流**: `workflows/review/review_workflow.yaml` 和文档
- **文档生成工作流**: `workflows/doc/doc_workflow.yaml` 和文档
- **需求评审工作流**: `workflows/requirement_review/req_review_workflow.yaml` 和文档
- **自定义任务工作流**: `workflows/custom/custom_workflow.yaml` 和文档
- **模板继承机制**: 支持基础模板和任务特定扩展

#### 3. 步骤类型支持 ✅
- **AI服务步骤**: 支持Claude和DeepSeek，支持提示词模板
- **Git操作步骤**: 支持fetch、commit、create_pr等操作
- **Shell脚本步骤**: 支持命令白名单和安全执行
- **数据获取步骤**: 支持文件和API数据源
- **文件导出步骤**: 支持多格式输出
- **验证步骤**: 支持DoD检查和内容验证

#### 4. 系统集成 ✅
- **TaskExecutor集成**: 添加`execute_with_workflow`方法
- **TaskManager集成**: 添加`execute_task_with_workflow`方法
- **CLI集成**: 添加`execute-workflow`命令
- **状态管理集成**: 与StateManager完全集成
- **通知服务集成**: 支持工作流事件通知

#### 5. 配置和文档 ✅
- **示例任务配置**: `config/tasks/coding_task_example.yaml`
- **使用指南**: `docs/工作流引擎使用指南.md`
- **提示词模板**: 完整的提示词模板结构
- **API文档**: 详细的类和方法文档

#### 6. 核心特性实现 ✅
- **双模式运行**: 人工审批模式和自动化模式
- **步骤级控制**: 完整的步骤执行和状态管理
- **工件管理**: 标准化命名和自动归档
- **错误处理**: 完善的异常处理和重试机制
- **安全机制**: 命令白名单和权限控制

### 技术亮点

1. **模块化设计**: 工作流引擎采用模块化设计，易于扩展和维护
2. **异步支持**: 完全支持异步执行，提高系统性能
3. **模板继承**: 支持工作流模板的继承和扩展
4. **类型安全**: 使用Python类型注解，提高代码质量
5. **配置驱动**: 通过YAML配置文件驱动工作流行为
6. **状态持久化**: 完整的工作流状态持久化和恢复

### 使用示例

#### 通过CLI执行工作流
```bash
# 使用工作流引擎执行任务
python -m src.cli.main execute-workflow coding_task_example

# 查看任务状态
python -m src.cli.main task-status coding_task_example
```

#### 编程方式使用
```python
from src.core import ConfigManager, TaskManager, StateManager
from src.services import NotifyService

# 初始化组件
config_manager = ConfigManager("./config")
state_manager = StateManager()
notify_service = NotifyService(config_manager)
task_manager = TaskManager(config_manager, state_manager, notify_service)

# 执行工作流任务
success = task_manager.execute_task_with_workflow("coding_task_example")
```

### 下一步计划

1. **完善提示词模板**: 补充各种任务类型的详细提示词
2. **增强验证机制**: 添加更多类型的DoD检查规则
3. **优化性能**: 进一步优化工作流执行性能
4. **扩展步骤类型**: 添加更多类型的步骤支持
5. **监控和告警**: 添加工作流执行监控和告警功能

### 总结

工作流引擎的实现完全满足了需求背景中提出的所有要求，包括：
- ✅ 工作流模板系统
- ✅ 双模式运行（人工审批/自动化）
- ✅ 步骤级控制和DoD检查
- ✅ 工件管理和状态持久化
- ✅ 与现有系统的完整集成
- ✅ 安全机制和错误处理
- ✅ 详细的文档和使用指南

工作流引擎为自动化AI任务执行系统提供了强大的核心能力，支持复杂的业务流程和自动化需求。