# 编码任务工作流程规范

## 概述
编码任务工作流基于基础模板扩展，专门用于AI驱动的代码生成和实现任务。该工作流包含完整的开发周期：需求分析、功能点分解、代码实现、测试验证、质量检查、代码提交和PR创建。

## 工作流程

### 1. 需求分析和功能点分解 (init)
- **目的**：理解任务需求，分解为具体的功能点
- **AI提示词**：使用 `coding_init_prompt` 模板
- **输出**：功能点表格，包含序号、接口/模块、变更点等信息
- **审批要求**：无需人工审批
- **表格格式**：
  | 序号 | 接口/模块/文件/类 | 新增/修改 | 变更点 | 影响范围 | 兼容性说明 | 风险/注意事项 | 测试点 |
  |------|-------------------|-----------|--------|----------|------------|---------------|--------|

### 2. 功能点选择 (select_features)
- **目的**：交互式选择要实现的功能点
- **执行方式**：支持快捷指令选择
- **输出**：确定的功能点列表和优先级
- **审批要求**：需要人工确认功能点选择
- **支持命令**：
  - `继续` - 实现所有功能点
  - `默认顺序` - 按依赖顺序自动执行
  - `选择序号X,Y` - 批量选择特定功能点
  - `跳过序号X,Y` - 跳过指定功能点

### 3. 生成实现计划 (plan)
- **目的**：生成详细的代码实现计划
- **AI提示词**：使用 `coding_plan_prompt` 模板
- **输出**：实现计划文档
- **审批要求**：需要人工确认实现计划
- **DoD检查**：计划完整性、技术可行性

### 4. 代码实现 (implement)
- **目的**：根据计划和选择的功能点生成实际代码
- **AI提示词**：使用 `coding_implement_prompt` 模板
- **输出**：源代码文件
- **审批要求**：无需人工审批

### 5. 单元测试执行 (test)
- **目的**：验证代码功能的正确性
- **执行方式**：运行项目的测试套件
- **输出**：测试结果报告
- **DoD检查**：测试通过率、覆盖率要求
- **支持的测试命令**：npm test, mvn test, pytest, go test

### 6. 项目构建 (build)
- **目的**：验证代码的构建完整性
- **执行方式**：运行项目构建命令
- **输出**：构建结果
- **DoD检查**：构建成功、无编译错误
- **支持的构建命令**：npm run build, mvn clean install, gradle build, make

### 7. 安全扫描 (security_scan)
- **目的**：检查代码和依赖的安全漏洞
- **执行方式**：运行安全扫描工具
- **输出**：安全扫描报告
- **DoD检查**：无高危漏洞、依赖安全
- **支持的扫描命令**：npm audit, mvn dependency:check, snyk test

### 8. 代码质量审查 (code_review)
- **目的**：AI驱动的代码质量检查
- **AI提示词**：使用 `coding_review_prompt` 模板
- **输出**：代码审查表格报告
- **DoD检查**：代码规范、质量指标
- **表格格式**：
  | 文件 | 类/函数 | 修改点 | 兼容性 | 风险 | 测试点 |
  |------|---------|--------|--------|------|--------|

### 9. 代码提交 (commit)
- **目的**：将代码提交到Git仓库
- **Git操作**：创建提交记录
- **输出**：提交哈希
- **审批要求**：无需人工审批

### 10. PR创建前人工审批 (approval_before_pr)
- **目的**：在创建PR前进行人工审查
- **执行方式**：暂停等待人工确认
- **输出**：审批状态和意见
- **审批要求**：必须人工审批
- **超时设置**：2小时

### 11. 创建Pull Request (create_pr)
- **目的**：创建代码审查请求
- **Git操作**：创建PR
- **输出**：PR链接
- **审批要求**：无需人工审批

### 12. 触发Review任务 (trigger_review)
- **目的**：自动触发协作的Review任务
- **执行方式**：创建新的Review任务实例
- **共享数据**：代码变更、提交记录、实现计划、测试结果
- **审批要求**：无需人工审批

### 13. 任务完成总结 (finalize)
- **目的**：生成任务完成报告
- **AI提示词**：使用 `coding_finalize_prompt` 模板
- **输出**：完成总结报告

## 参考功能开发编码prompt流程

基于您提供的参考文件，本工作流实现了以下对应关系：

### 阶段对应
1. **列出待实现功能点列表** → `init` 步骤
2. **选择功能点** → `select_features` 步骤
3. **开始实现（示例代码）** → `plan` + `implement` 步骤
4. **验证实现（DoD）** → `test` + `build` + `security_scan` + `code_review` 步骤
5. **继续选择接口或功能点** → 通过快捷指令循环支持
6. **全部实现完成** → `finalize` 步骤
7. **代码应用** → `commit` + `create_pr` 步骤

### 交互式确认
- 支持"继续"、"默认顺序"、"选择序号X,Y"等快捷指令
- 在关键节点暂停等待人工审批
- 支持manual/auto两种运行模式

### DoD验证机制
- 包含编码规范、构建、兼容性、性能、安全检查
- 输出修改点表格格式
- 支持配置化的验证规则

## DoD验证规则

### 测试验证
- 单元测试通过率 ≥ 80%
- 测试覆盖率 ≥ 70%
- 无测试失败

### 构建验证
- 项目构建成功
- 无编译错误
- 无依赖冲突

### 安全验证
- 安全扫描通过
- 无高危漏洞
- 依赖包安全

### 代码质量验证
- 代码规范检查通过
- 无严重代码异味
- 复杂度在合理范围内

## 协作机制

### 与Review任务协作
- 编码任务完成后自动触发Review任务
- 共享关键产物：代码变更、提交记录、实现计划、测试结果
- 通过线程隔离机制确保任务独立性

### 状态共享
- 使用状态文件记录任务进度和产物
- Review任务可读取编码任务的输出进行分析
- 支持任务间的依赖关系管理

## 配置选项

### 工作流特定配置
- `branch_management`: 是否启用分支管理
- `code_review_integration`: 是否集成代码审查
- `testing_required`: 是否要求测试执行
- `security_scanning`: 是否启用安全扫描
- `feature_decomposition`: 是否启用功能点分解
- `collaboration_enabled`: 是否启用协作机制

### 步骤级配置
每个步骤都可以配置：
- `pause_for_approval`: 是否暂停等待审批
- `dod_check`: 是否执行DoD验证
- `timeout`: 步骤超时时间
- 特定步骤的配置参数

## 产物输出

### 主要产物
- 功能点分解表格
- 实现计划文档
- 源代码文件
- 测试报告
- 构建日志
- 安全扫描报告
- 代码审查表格
- 任务完成报告

### 产物命名
所有产物按照 `{task_id}/{timestamp}/{step_name}` 的格式命名，确保唯一性和可追溯性。

## 扩展和定制

### 步骤覆盖
- 可以禁用不需要的步骤（如安全扫描）
- 可以修改步骤的配置参数
- 可以调整DoD验证规则

### 模板定制
- 可以修改AI提示词模板文件路径
- 可以调整测试和构建命令
- 可以自定义审批流程和超时时间
