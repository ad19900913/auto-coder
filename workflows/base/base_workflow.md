# 基础工作流规范

## 概述
基础工作流模板定义了所有任务类型的通用步骤和配置选项，为具体任务类型提供基础框架。该模板实现了双模式运行、步骤级控制、产物管理、错误处理等核心功能。

## 运行模式

### 自动化模式 (auto)
- **特点**：全自动执行，无需人工干预
- **适用场景**：夜间无人值守执行
- **交互**：仅在配置的人工审批步骤处暂停
- **快捷指令**：不支持

### 人工审批模式 (manual)
- **特点**：支持交互式确认和快捷指令
- **适用场景**：工作时间人工监督执行
- **交互**：可在关键步骤处暂停等待审批
- **快捷指令**：支持以下命令
  - `继续` - 继续执行下一步骤
  - `默认顺序` - 按系统建议的顺序执行
  - `选择序号X,Y` - 批量选择特定项目
  - `跳过序号X,Y` - 跳过指定项目
  - `重新执行` - 重新执行当前步骤
  - `终止任务` - 终止整个工作流

## 步骤类型

### 1. AI调用步骤 (ai_call)
- **功能**：调用AI服务完成具体任务
- **配置**：模型选择、提示词、参数调优
- **输出**：AI响应内容、元数据、Token使用量
- **超时**：默认300秒
- **重试**：最多3次

### 2. Git操作步骤 (git_operation)
- **功能**：执行Git相关操作
- **配置**：操作类型、分支、提交信息、PR配置
- **输出**：操作状态、提交ID、PR链接
- **超时**：默认600秒
- **重试**：最多2次

### 3. 人工审批步骤 (human_approval)
- **功能**：暂停执行等待人工审批
- **配置**：超时时间、审批方式、提示信息
- **输出**：审批状态、意见、审批人
- **超时**：默认7200秒（2小时）
- **重试**：1次

### 4. 脚本执行步骤 (script_execution)
- **功能**：在指定目录执行Shell脚本
- **配置**：命令、工作目录、环境变量、白名单
- **输出**：退出码、输出内容、错误信息
- **超时**：默认1800秒（30分钟）
- **重试**：最多2次
- **安全**：支持命令白名单和工作目录限制

### 5. DoD验证步骤 (dod_check)
- **功能**：执行Definition of Done验证
- **配置**：检查项目、严重程度、自动修复
- **输出**：验证结果、问题列表、质量评分
- **超时**：默认180秒
- **重试**：1次

### 6. 文件操作步骤 (file_operation)
- **功能**：执行文件系统操作
- **配置**：操作类型、路径、格式、权限
- **输出**：操作状态、文件路径、文件大小
- **超时**：默认300秒
- **重试**：最多2次

### 7. 通知步骤 (notification)
- **功能**：发送通知消息
- **配置**：通知类型、接收者、模板、优先级
- **输出**：发送状态、消息ID
- **超时**：默认60秒
- **重试**：最多3次

### 8. 任务触发步骤 (task_trigger)
- **功能**：触发其他任务执行
- **配置**：目标任务类型、共享产物、依赖关系
- **输出**：触发状态、新任务ID
- **超时**：默认120秒
- **重试**：1次

## 默认步骤序列

基础工作流提供最小的步骤序列：

1. **init** - 任务初始化
2. **execute** - 主要执行
3. **validate** - 结果验证（可选）
4. **finalize** - 完成总结

具体任务类型可以通过继承扩展更多步骤。

## 通知策略

### errors_and_critical（默认）
- 仅在错误和关键节点通知
- 包括：步骤错误、AI调用、Git操作、人工审批、任务完成/失败

### all_steps
- 所有步骤都发送通知
- 包括：步骤开始/完成/错误/跳过、任务完成/失败

### minimal
- 最少通知
- 仅包括：任务完成/失败、严重错误

## 错误处理

### 重试策略
- **默认重试次数**：最多3次
- **退避策略**：指数退避，初始延迟5秒，最大延迟300秒
- **退避倍数**：2倍递增

### 失败处理
- **continue**：继续执行后续步骤
- **abort**：终止整个工作流
- **retry**：重试当前步骤
- **skip**：跳过当前步骤

### 关键步骤
- **init** 和 **finalize** 步骤失败时必须终止工作流
- 其他步骤可根据配置选择处理方式

## 产物管理

### 命名规范
- 产物采用 `{task_id}/{timestamp}/{step_name}` 的命名方式
- 确保唯一性和可追溯性
- 支持按时间和步骤进行分类

### 保留策略
- **默认保留**：30天
- **重要产物**：90天
- **清理计划**：每天凌晨2点自动清理

### 归档规则
- **压缩时机**：7天后自动压缩
- **归档位置**：./archives目录
- **压缩格式**：ZIP格式

## 质量控制

### AI调用验证
- 响应内容非空
- 响应格式正确
- Token使用在限制内

### Git操作验证
- 操作执行成功
- 无冲突产生
- 权限验证通过

### 脚本执行验证
- 退出码为0
- 无严重错误输出
- 执行时间在限制内

### 文件操作验证
- 文件操作成功
- 文件完整性检查通过
- 权限设置正确

## 安全配置

### 脚本执行安全
- **白名单命令**：npm, mvn, gradle, python, pytest, go, docker
- **禁用模式**：rm -rf, del /f, format, shutdown, reboot
- **目录限制**：仅允许在任务指定的工作目录下执行
- **环境隔离**：支持环境变量隔离

### 文件访问安全
- **允许扩展名**：.md, .txt, .json, .yaml, .csv, .xlsx, .pdf
- **禁止路径**：/system, /windows, /etc, ~/.ssh
- **权限控制**：基于文件类型的访问控制

## 扩展机制

### 模板继承
- 具体任务类型可以继承基础模板
- 支持步骤覆盖和配置覆盖
- 继承策略：merge（合并）、replace（替换）、append（追加）

### 允许覆盖
- 步骤序列（steps_sequence）
- DoD规则（dod_rules）
- 通知配置（notification_config）
- 超时值（timeout_values）

### 保护元素
- 安全配置（security_config）
- 错误处理（error_handling）
- 产物管理（artifact_management）

### 扩展点
- **前置钩子**：日志记录、安全检查、资源检查
- **后置钩子**：清理、通知、产物保存
- **自定义验证器**：业务规则检查、合规性检查、性能检查

## 配置优先级

从高到低的配置优先级：
1. 任务实例配置
2. 任务类型模板配置
3. 基础模板配置
4. 全局默认配置

## 使用指南

### 创建新的任务类型
1. 继承基础工作流模板
2. 定义特定的步骤序列
3. 配置任务特定的参数
4. 设置DoD验证规则
5. 编写人类可读的说明文档

### 自定义步骤
1. 基于现有步骤模板
2. 配置特定参数
3. 设置超时和重试策略
4. 定义输入输出格式

### 调试和监控
1. 查看步骤执行日志
2. 监控产物生成情况
3. 检查错误处理机制
4. 验证通知发送状态
