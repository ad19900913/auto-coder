# 工作流程规范系统

## 概述

本目录包含了自动化AI任务执行系统的完整工作流程规范，为五种不同的任务类型提供了结构化的执行模板。每种工作流都基于统一的基础模板，确保一致性和可维护性。

## 工作流类型

### 1. 基础工作流 (base/)
- **文件**：`base_workflow.yaml`, `base_workflow.md`
- **用途**：所有任务类型的基础模板
- **特性**：双模式运行、步骤级控制、产物管理、错误处理
- **扩展**：为其他工作流提供继承基础

### 2. 编码任务工作流 (coding/)
- **文件**：`coding_workflow.yaml`, `coding_workflow.md`
- **用途**：AI驱动的代码生成和实现
- **特性**：功能点分解、交互式选择、DoD验证、协作机制
- **流程**：需求分析 → 功能选择 → 计划 → 实现 → 测试 → 构建 → 安全扫描 → 审查 → 提交 → PR

### 3. 代码走查工作流 (review/)
- **文件**：`review_workflow.yaml`, `review_workflow.md`
- **用途**：AI驱动的代码质量审查
- **特性**：多维度审查、独立/协作模式、质量评分
- **流程**：范围分析 → 范围选择 → 代码分析 → 架构审查 → 安全审查 → 性能审查 → 报告生成

### 4. 文档生成工作流 (doc/)
- **文件**：`doc_workflow.yaml`, `doc_workflow.md`
- **用途**：AI驱动的文档生成
- **特性**：多格式支持、模板驱动、图表生成、版本控制
- **流程**：需求分析 → 章节选择 → 数据收集 → 大纲生成 → 内容生成 → 图表生成 → 格式转换

### 5. 需求评审工作流 (requirement_review/)
- **文件**：`req_review_workflow.yaml`, `req_review_workflow.md`
- **用途**：需求文档与代码实现的一致性分析
- **特性**：文档分析、代码分析、一致性检查、差距分析
- **流程**：初始化 → 维度选择 → 需求分析 → 代码分析 → 一致性检查 → 差距分析 → 报告生成

### 6. 自定义任务工作流 (custom/)
- **文件**：`custom_workflow.yaml`, `custom_workflow.md`
- **用途**：灵活的自定义任务执行
- **特性**：灵活目标、多格式输出、数据预处理、迭代优化
- **流程**：目标分析 → 目标选择 → 数据预处理 → 策略制定 → 分析执行 → 洞察生成 → 多格式输出

## 核心特性

### 双模式运行
- **自动化模式 (auto)**：夜间无人值守执行，全程自动化
- **人工审批模式 (manual)**：工作时间交互式执行，支持快捷指令

### 交互式控制
**支持的快捷指令**：
- `继续` - 继续执行或选择所有项目
- `默认顺序` - 按系统建议的优先级执行
- `选择序号X,Y` - 批量选择特定项目
- `跳过序号X,Y` - 跳过指定项目
- `重新执行` - 重新执行当前步骤
- `终止任务` - 终止整个工作流

### 步骤级控制
- **暂停审批**：可配置在特定步骤暂停等待人工确认
- **DoD验证**：Definition of Done检查，确保质量标准
- **错误处理**：支持重试、跳过、终止等策略
- **超时管理**：每个步骤都有独立的超时设置

### 产物管理
- **命名规范**：`{task_id}/{timestamp}/{step_name}`
- **自动清理**：30天保留期，重要产物90天
- **归档机制**：7天后自动压缩，保存到archives目录

### 协作机制
- **任务链接**：编码任务完成后自动触发Review任务
- **状态共享**：通过状态文件和共享产物实现任务间协作
- **线程隔离**：每个任务对应独立线程，确保并发安全

## 配置继承

### 继承层次
```
全局默认配置
    ↓
基础模板配置 (base_workflow.yaml)
    ↓
任务类型配置 (如 coding_workflow.yaml)
    ↓
任务实例配置 (如 example_coding_task.yaml)
```

### 配置优先级
任务实例配置 > 任务类型配置 > 基础模板配置 > 全局默认配置

### 允许覆盖
- 步骤序列定义
- DoD验证规则
- 通知配置策略
- 超时时间设置

### 保护配置
- 安全策略配置
- 错误处理机制
- 产物管理规则

## 安全机制

### 脚本执行安全
- **命令白名单**：仅允许预定义的安全命令
- **目录限制**：仅能在任务指定的工作目录下执行
- **禁用模式**：阻止危险的系统命令
- **环境隔离**：独立的环境变量空间

### 文件访问控制
- **扩展名限制**：仅允许特定类型的文件
- **路径保护**：禁止访问系统关键目录
- **权限控制**：基于文件类型的访问权限

## 质量保证

### DoD验证体系
每种任务类型都有特定的验证规则：
- **编码任务**：测试覆盖率、构建成功、安全扫描、代码质量
- **Review任务**：代码质量评分、安全漏洞检查、性能评估
- **文档任务**：内容完整性、格式正确性、链接有效性
- **需求评审**：一致性匹配度、差距识别完整性、风险评估准确性
- **自定义任务**：数据完整性、分析覆盖率、建议可操作性

### 错误处理
- **重试机制**：指数退避策略，自动重试失败的步骤
- **故障转移**：关键步骤失败时的备用方案
- **状态恢复**：支持从中断点恢复执行

## 通知策略

### 默认策略：errors_and_critical
仅在以下情况发送通知：
- 步骤执行错误
- AI服务调用（关键节点）
- Git操作（提交、PR）
- 人工审批需要
- 任务完成/失败

### 其他策略
- **all_steps**：所有步骤都发送通知
- **minimal**：仅任务完成/失败和严重错误

## 使用指南

### 1. 选择合适的工作流类型
根据任务需求选择对应的工作流模板：
- 代码开发 → `coding_workflow`
- 代码审查 → `review_workflow`
- 文档编写 → `doc_workflow`
- 需求对比 → `requirement_review_workflow`
- 其他任务 → `custom_workflow`

### 2. 配置任务参数
在任务配置文件中指定：
```yaml
workflow:
  type: "coding"  # 工作流类型
  mode: "manual"  # 运行模式
  steps_override:  # 步骤覆盖
    - name: "approval_before_pr"
      pause_for_approval: true
```

### 3. 自定义步骤
可以覆盖默认步骤的配置：
- 修改超时时间
- 调整DoD验证规则
- 自定义AI提示词模板
- 配置特定的工具命令

### 4. 监控执行过程
- 查看实时日志输出
- 监控步骤执行状态
- 检查产物生成情况
- 接收关键节点通知

## 扩展开发

### 创建新的工作流类型
1. 在对应目录下创建 `{type}_workflow.yaml`
2. 继承 `base_workflow` 并定义特定步骤
3. 编写对应的 `{type}_workflow.md` 说明文档
4. 在任务执行器中注册新类型

### 添加自定义步骤
1. 在基础模板中定义新的步骤模板
2. 实现对应的执行逻辑
3. 配置安全策略和验证规则
4. 更新文档说明

### 修改验证规则
1. 在工作流配置中添加 `dod_rules`
2. 定义检查项目和通过标准
3. 实现自动化验证逻辑
4. 配置失败处理策略

## 最佳实践

### 1. 合理设置超时时间
- AI调用：5-10分钟
- 构建操作：10-30分钟
- 人工审批：1-2小时
- 安全扫描：3-5分钟

### 2. 优化DoD规则
- 设置合理的通过阈值
- 包含关键的质量指标
- 考虑项目特定需求
- 定期审查和调整

### 3. 配置通知策略
- 避免通知过载
- 关注关键节点
- 区分不同优先级
- 支持多种通知渠道

### 4. 安全考虑
- 严格限制脚本执行权限
- 定期审查命令白名单
- 保护敏感配置信息
- 监控异常访问行为

## 故障排除

### 常见问题
1. **步骤超时**：检查网络连接和资源使用情况
2. **验证失败**：查看具体的错误信息和日志
3. **权限错误**：确认文件和目录的访问权限
4. **配置错误**：验证YAML语法和参数有效性

### 调试技巧
1. 启用详细日志记录
2. 使用manual模式逐步执行
3. 检查中间产物的生成情况
4. 验证AI服务和Git服务的连接状态

## 版本管理

### 当前版本：1.0
- 支持五种任务类型的工作流
- 实现双模式运行机制
- 提供完整的质量保证体系
- 包含安全防护和错误处理

### 升级指南
当工作流模板更新时：
1. 备份现有配置
2. 更新模板文件
3. 检查配置兼容性
4. 测试新功能
5. 逐步切换到新版本
